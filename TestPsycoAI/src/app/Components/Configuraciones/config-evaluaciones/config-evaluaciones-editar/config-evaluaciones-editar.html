<div class="container mt-5">
  <div class="card shadow-lg">
    
    <div class="card-header bg-secondary text-white text-center d-flex justify-content-between align-items-center">
            <a class="text-white" [routerLink]="['/configuraciones/evaluaciones']">
            <h3><i class="fa fa-arrow-left"></i></h3> 
            </a>
          <h3 class="mb-0 flex-grow-1 text-center"><i class="fa-solid fa-screwdriver-wrench"></i> Editar Configuraciones de {{ evaluacion.nombre }}</h3>
        </div>
    <div class="card-body">
        

        <div class="row">
            <div class="mb-3 col-md-6">
                <label for="tipoTest" class="form-label "><strong>Descripción:</strong> {{ evaluacion.tipoTest.descripcion }} </label>
            </div>
        </div>
        <div class="row">
            <div class="mb-4 col-md-4">
                <label for="duracion" class="form-label"><strong>Duración:</strong> {{ evaluacion.duracion }} segundos <strong>ó</strong> {{ evaluacion.duracion/60 }} minutos</label>

            </div> 
        </div>
        <div>

    </div>
        <div class="row col-md-4">
            <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                <button type="button" class="btn btn-warning"  data-bs-toggle="modal" (click)="cargarEdicion()" data-bs-target="#editarEvaluacionModal">
                    <i class="fa fa-pen-to-square"></i> {{ evaluacion.nombre }}
                </button>
                <button type="button" class="btn btn-light " data-bs-toggle="modal" data-bs-target="#instruccionesModal">
                    <i class="fa fa-eye"></i> Instrucciones
                </button>


                <button type="button" class="btn btn-primary "  data-bs-toggle="modal" data-bs-target="#agregarSeccionModal" >
                    <i class="fa fa-plus"></i> Sección
                </button>
            </div>
        </div>

    <br>
    <div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Secciones de {{ evaluacion.nombre }}</h5>
    </div>
    <div class="card-body p-0">
        <div class="list-group list-group-flush ">

        @for (seccion of evaluacion.configuracionesSecciones; track $index) {
                <a class="list-group-item  list-group-item-action bg-secondary text-white" 
                    data-bs-toggle="collapse" 
                    [attr.href]="'#' + seccion.id" 
                    role="button" 
                    [class.active]="true"
                    aria-expanded="true" 
                    [attr.aria-controls]="seccion.id">
                    {{ seccion.seccion }}
                    
                </a>
                
                <div class="collapse show" [id]="seccion.id">
                    <div class="card card-body border-0 border-top rounded-0">
                        <div>
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Configuración de {{ seccion.seccion }}</h5> 
                                        <label class="ms-3">Formato de Cálculo: {{ seccion.formulaAgregado }}</label>
                                        <div>
                                            <label class="ms-3">Las preguntas que se seleccionan en la evaluación son {{ seccion.numeroPreguntas }} seleccionadas aleatoriamente de {{ seccion.bancoPreguntas?.length }} configuradas para esta sección</label>
                                        </div>
                                        <button class="btn btn-sm btn-danger float-end me-2" (click)="eliminarSeccion(seccion.id!)"><i class="fa fa-trash"></i> Sección</button>
                                        <button class="btn btn-sm btn-warning float-end me-2" 
                                          data-bs-toggle="modal" 
                                          data-bs-target="#editarSeccionModal" 
                                          (click)="cargarSeccionEditable(seccion)"
                                        >
                                          <i class="fa fa-pen-to-square" ></i> Sección
                                        </button>
                                        <button class="btn btn-sm btn-primary float-end me-2" 
                                          data-bs-toggle="modal" 
                                          data-bs-target="#agregarPreguntaModal" 
                                          (click)="cargarPreguntaNueva(seccion)" 
                                        >
                                          <i class="fa fa-plus"></i> Pregunta
                                        </button>

                                        <br>
                                        <div class="table-responsive mt-3">
                                            <table class="table table-bordered">
                                                <thead class="table-dark">
                                                        <tr>
                                                                <th>Pregunta</th>
                                                                <th>Opciones</th>
                                                        </tr>
                                                </thead>
                                                <tbody>
                                                  @for (pregunta of seccion.bancoPreguntas; track $index) {
                                                    <tr>
                                                      <td>
                                                        {{ pregunta.pregunta }}
                                                        <div class="mt-2">
                                                          <div class="d-grid gap-2 d-md-flex flex-md-row flex-wrap">
                                                          <button class="btn btn-sm btn-primary me-2 mb-2" 
                                                            data-toggle="tooltip" 
                                                            data-placement="top" 
                                                            title="Agregar Opción" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#agregarOpcionModal" 
                                                            (click)="cargarOpcionNueva(pregunta)">
                                                            <i class="fa fa-plus"></i>
                                                          </button>
                                                            
                                                          <button class="btn btn-sm btn-warning mb-2"
                                                            (click)="cargarEdicionPregunta(pregunta)"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#editarPreguntaModal"
                                                            >
                                                            <i class="fa fa-pen-to-square"></i>
                                                          </button>
                                                          
                                                          <button class="btn btn-sm btn-danger me-2 mb-2"
                                                            (click)="eliminarPregunta(pregunta)">
                                                            <i class="fa fa-trash"></i>
                                                          </button>
                                                          </div>
                                                        </div>
                                                      </td>
                                                      <td>
                                                        <ul class="list-group">
                                                          @for (opcion of pregunta.opciones; track $index) {
                                                            <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                                                              <span class="mb-2 mb-md-0">
                                                                <button class="btn btn-sm btn-outline-primary me-2 mb-2 mb-md-0" 
                                                                (click)="cargarEdicionOpcion(opcion)"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#editarOpcionModal"
                                                                >
                                                                  <i class="fa fa-pen-to-square"></i>
                                                                </button>
                                                                {{ opcion.orden }} - {{ opcion.opcion }} (Calificación: {{ opcion.peso }})  
                                                              </span>
                                                              <span class="d-grid gap-2 d-md-flex flex-md-row flex-wrap">
                                                                @if($index > 0)
                                                                {
                                                                  <button class="btn btn-sm btn-outline-secondary me-1 mb-2" 
                                                                  (click)="moverOpcionArriba(pregunta, opcion)">
                                                                    <i class="fa fa-arrow-up"></i>
                                                                  </button>
                                                                } @else {
                                                                  <button class="btn btn-sm btn-outline-secondary me-1 mb-2" 
                                                                  disabled>
                                                                    <i class="fa fa-arrow-up"></i>
                                                                  </button>
                                                                }
                                                                @if($index < (pregunta.opciones?.length ?? 0) - 1)
                                                                {
                                                                  <button class="btn btn-sm btn-outline-secondary me-2 mb-2" 
                                                                  (click)="moverOpcionAbajo(pregunta, opcion)">
                                                                    <i class="fa fa-arrow-down"></i>
                                                                  </button>
                                                                }@else {
                                                                  <button class="btn btn-sm btn-outline-secondary me-2 mb-2" 
                                                                  disabled>
                                                                    <i class="fa fa-arrow-down"></i>
                                                                  </button>
                                                                }
                                                                <button class="btn btn-sm btn-outline-danger mb-2" (click)="eliminarOpcion(pregunta, opcion)">
                                                                  <i class="fa fa-trash"></i>
                                                                </button>
                                                              </span>
                                                            </li>
                                                          }
                                                        </ul>
                                                      </td>
                                                    </tr>
                                                }
                                                </tbody>
                                            </table>
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>



<!-- Modal de instrucciones -->
<div class="modal fade" id="instruccionesModal" tabindex="-1" aria-labelledby="instruccionesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="instruccionesModalLabel">
          Instrucciones de {{ evaluacion.tipoTest.nombre }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        
             <div class="card" >
            <ul class="list-group list-group-flush">
                <li class="list-group-item bg-success text-white text-center"><h4>Vista Previa Instrucciones</h4></li>

                <li class="list-group-item"><div [innerHTML]="evaluacion.tipoTest.instrucciones"></div></li>
            </ul>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal para agregar sección -->
<div class="modal fade" id="agregarSeccionModal" tabindex="-1" aria-labelledby="agregarSeccionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #agregarSeccionForm="ngForm" (ngSubmit)="agregarSeccion()">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="agregarSeccionModalLabel">Agregar Sección</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="seccion" class="form-label">Sección</label>
            <input
              type="text"
              id="seccion"
              name="seccion"
              class="form-control"
              [(ngModel)]="nuevaSeccion.seccion"
              required
            />
          </div>
          <div class="mb-3">
            <label for="numeroPreguntas" class="form-label">Número de Preguntas</label>
            <input
              type="number"
              id="numeroPreguntas"
              name="numeroPreguntas"
              class="form-control"
              [(ngModel)]="nuevaSeccion.numeroPreguntas"
              min="1"
              required
            />
          </div>
          <div class="mb-3">
            <label for="formulaAgregado" class="form-label">Fórmula de Agregado</label>
            <select
              id="formulaAgregado"
              name="formulaAgregado"
              class="form-select"
              [(ngModel)]="nuevaSeccion.formulaAgregado"
              required
            >
              <option value="" disabled selected>Seleccione una opción</option>
              <option value="AVG">AVG</option>
              <option value="SUM">SUM</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="agregarSeccionForm.invalid">
            <i class="fa fa-plus"></i> Agregar
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar sección -->
<div class="modal fade" id="editarSeccionModal" tabindex="-1" aria-labelledby="editarSeccionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #editarSeccionForm="ngForm" (ngSubmit)="editarSeccion()">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="editarSeccionModalLabel">Editar Sección</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editarSeccionNombre" class="form-label">Nombre de la Sección</label>
            <input
              type="text"
              id="editarSeccionNombre"
              name="editarSeccionNombre"
              class="form-control"
              [(ngModel)]="seccionSelecionada.seccion"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editarNumeroPreguntas" class="form-label">Número de Preguntas</label>
            <input
              type="number"
              id="editarNumeroPreguntas"
              name="editarNumeroPreguntas"
              class="form-control"
              [(ngModel)]="seccionSelecionada.numeroPreguntas"
              min="1"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editarFormulaAgregado" class="form-label">Fórmula de Agregado</label>
            <select
              id="editarFormulaAgregado"
              name="editarFormulaAgregado"
              class="form-select"
              [(ngModel)]="seccionSelecionada.formulaAgregado"
              required
            >
              <option value="" disabled>Seleccione una opción</option>
              <option value="AVG">AVG</option>
              <option value="SUM">SUM</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="editarSeccionForm.invalid">
            <i class="fa fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar evaluación -->
<div class="modal fade" id="editarEvaluacionModal" tabindex="-1" aria-labelledby="editarEvaluacionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #editarEvaluacionForm="ngForm" (ngSubmit)="editarEvaluacion()">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="editarEvaluacionModalLabel">Editar Evaluación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nombreEvaluacion" class="form-label">Nombre de la Evaluación</label>
            <input
              type="text"
              id="nombreEvaluacion"
              name="nombreEvaluacion"
              class="form-control"
              [(ngModel)]="evaluacion.nombre"
              required
            />
          </div>
          <div class="mb-3">
            <label for="duracionEvaluacion" class="form-label">Duración (segundos)</label>
            <input
              type="number"
              id="duracionEvaluacion"
              name="duracionEvaluacion"
              class="form-control"
              [(ngModel)]="evaluacionEditable.duracion"
              min="1"
              required
            />
          </div>
          <div class="mb-3">
            <label for="tipoTestEvaluacion" class="form-label">Tipo de Test</label>
            <select
              id="tipoTestEvaluacion"
              name="tipoTestEvaluacion"
              class="form-select"
              [(ngModel)]="evaluacionEditable.idTipoTest"
              required
            >
              <option value="" disabled selected>Seleccione una opción</option>
              @for (tipo of tiposTest; track $index) {
                  @if (tipo.id === evaluacion.tipoTest.id) {
                    <option [value]="tipo.id" selected>{{ tipo.nombre }}</option>
                  } @else {
                    <option [value]="tipo.id">{{ tipo.nombre }}</option>
                  }
              }
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="editarEvaluacionForm.invalid" (click)="editarEvaluacion()">
            <i class="fa fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Modal para agregar pregunta -->
<div class="modal fade" id="agregarPreguntaModal" tabindex="-1" aria-labelledby="agregarPreguntaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #agregarPreguntaForm="ngForm" (ngSubmit)="agregarPregunta()">
        <div class="modal-header bg-primary text-white">

          <h5 class="modal-title" id="agregarPreguntaModalLabel">Agregar Pregunta de {{ seccionSelecionada.seccion }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
            <div class="mb-6">
            <label for="preguntaTexto" class="form-label">Pregunta</label>
            <input
              type="text"
              id="preguntaTexto"
              name="preguntaTexto"
              class="form-control"
              [(ngModel)]="nuevaPregunta.pregunta"
              required
            />
            </div>
          <div class="mb-3">
            
            <input
              type="checkbox"
              id="inversa"
              name="inversa"
              class="form-check-input me-2"
              [(ngModel)]="nuevaPregunta.inversa"
              
            />
            <label for="inversa" class="form-label">Invertida</label>
          </div>
         
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="agregarPreguntaForm.invalid">
            <i class="fa fa-plus"></i> Agregar
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar pregunta -->
<div class="modal fade" id="editarPreguntaModal" tabindex="-1" aria-labelledby="editarPreguntaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #editarPreguntaForm="ngForm" (ngSubmit)="editarPregunta()">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="editarPreguntaModalLabel">Editar Pregunta de {{ seccionSelecionada.seccion }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editarPreguntaTexto" class="form-label">Pregunta</label>
            <input
              type="text"
              id="editarPreguntaTexto"
              name="editarPreguntaTexto"
              class="form-control"
              [(ngModel)]="preguntaEditable.pregunta"
              required
            />
          </div>
          <div class="mb-3">
            <input
              type="checkbox"
              id="editarInversa"
              name="editarInversa"
              class="form-check-input me-2"
              [(ngModel)]="preguntaEditable.inversa"
            />
            <label for="editarInversa" class="form-label">Invertida</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="editarPreguntaForm.invalid">
            <i class="fa fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para añadir opción -->
<div class="modal fade" id="agregarOpcionModal" tabindex="-1" aria-labelledby="agregarOpcionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #agregarOpcionForm="ngForm" (ngSubmit)="agregarOpcion()">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="agregarOpcionModalLabel">Añadir Opción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex align-items-center">
            <label class="form-label me-2 mb-0"><strong>Pregunta:</strong></label>
            <div class="form-control-plaintext mb-0">{{ preguntaSeleccionada.pregunta }}</div>
          </div>
          <div class="mb-3 d-flex align-items-center">
            <label class="form-label me-2 mb-0"><strong>Orden:</strong></label>
            <div class="form-control-plaintext mb-0">{{ nuevaOpcion.orden }}</div>
          </div>
          <div class="mb-3">
            <label for="opcionTexto" class="form-label">Opción</label>
            <input
              type="text"
              id="opcionTexto"
              name="opcionTexto"
              class="form-control"
              [(ngModel)]="nuevaOpcion.opcion"
              required
            />
          </div>
          <div class="mb-3">
            <label for="pesoOpcion" class="form-label">Peso</label>
            <input
              type="number"
              id="pesoOpcion"
              name="pesoOpcion"
              class="form-control"
              [(ngModel)]="nuevaOpcion.peso"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="agregarOpcionForm.invalid">
            <i class="fa fa-plus"></i> Añadir
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar opción -->
<div class="modal fade" id="editarOpcionModal" tabindex="-1" aria-labelledby="editarOpcionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form #editarOpcionForm="ngForm" (ngSubmit)="editarOpcion()">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="editarOpcionModalLabel">Editar Opción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex align-items-center">
            <label class="form-label me-2 mb-0"><strong>Pregunta:</strong></label>
            <div class="form-control-plaintext mb-0">{{ preguntaSeleccionada.pregunta }}</div>
          </div>
          <div class="mb-3 d-flex align-items-center">
            <label class="form-label me-2 mb-0"><strong>Orden:</strong></label>
            <div class="form-control-plaintext mb-0">{{ opcionEditable.orden }}</div>
          </div>
          <div class="mb-3">
            <label for="editarOpcionTexto" class="form-label">Opción</label>
            <input
              type="text"
              id="editarOpcionTexto"
              name="editarOpcionTexto"
              class="form-control"
              [(ngModel)]="opcionEditable.opcion"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editarPesoOpcion" class="form-label">Peso</label>
            <input
              type="number"
              id="editarPesoOpcion"
              name="editarPesoOpcion"
              class="form-control"
              [(ngModel)]="opcionEditable.peso"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" [disabled]="editarOpcionForm.invalid">
            <i class="fa fa-save"></i> Guardar Cambios
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>